"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e["default"]:e}function assertBrowserEnvironment(){if(!globals.window)throw new Error("Sign-in type not supported in this environment")}function assertDefAndNotNull(e,t){if(!metal.core.isDefAndNotNull(e))throw new Error(t)}function assertFunction(e,t){if(!metal.core.isFunction(e))throw new Error(t)}function assertObject(e,t){if(!metal.core.isObject(e))throw new Error(t)}function assertResponseSucceeded(e){if(!e.succeeded())throw e.body();return e}function assertUserSignedIn(e){if(!metal.core.isDefAndNotNull(e))throw new Error("You must be signed-in to perform this operation")}function assertUriWithNoPath(e,t){var r=new Uri(e);if(r.getPathname().length>1)throw new Error(t)}function assertStringIfDefAndNotNull(e,t){if(metal.core.isDefAndNotNull(e)&&!metal.core.isString(e))throw new Error(t)}function assertSupportedProvider(e){switch(e.constructor.PROVIDER){case FacebookAuthProvider.PROVIDER:case GithubAuthProvider.PROVIDER:case GoogleAuthProvider.PROVIDER:break;default:throw new Error("Sign-in provider not supported")}}var io=_interopDefault(require("socket.io-client")),metal=require("metal"),Uri=_interopDefault(require("metal-uri")),metalStorage=require("metal-storage"),Ajax=_interopDefault(require("metal-ajax")),metalStructs=require("metal-structs"),http=_interopDefault(require("http")),_request=_interopDefault(require("request")),CancellablePromise=_interopDefault(require("metal-promise")),classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}(),get$1=function e(t,r,n){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,r);if(void 0===i){var o=Object.getPrototypeOf(t);return null===o?void 0:e(o,r,n)}if("value"in i)return i.value;var a=i.get;if(void 0!==a)return a.call(n)},inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},set=function t(e,r,n,i){var o=Object.getOwnPropertyDescriptor(e,r);if(void 0===o){var a=Object.getPrototypeOf(e);null!==a&&t(a,r,n,i)}else if("value"in o&&o.writable)o.value=n;else{var u=o.set;void 0!==u&&u.call(i,n)}return n},toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return Array.from(e)},Embodied=function(){function e(){classCallCheck(this,e),this.body_={}}return createClass(e,[{key:"body",value:function(){return this.body_}},{key:"toString",value:function(){return JSON.stringify(this.body())}}],[{key:"toBody",value:function(t){return t instanceof e?t.body():t}}]),e}(),FilterBody=function(){function e(t,r,n){classCallCheck(this,e);var i={operator:metal.core.isDef(n)?r:"="},o=metal.core.isDef(n)?n:r;metal.core.isDefAndNotNull(o)&&(o instanceof Embodied&&(o=o.body()),i.value=o),metal.core.isDefAndNotNull(t)?this.createBody_(t,i):this.createBody_("and",[])}return createClass(e,[{key:"add",value:function(e,t){t?this.addArrayOperator_(e,t):this.createBody_(e,this.body_)}},{key:"addArrayOperator_",value:function(e,t){this.body_[e]instanceof Array||this.createBody_(e,[this.body_]),this.body_[e].push(t.body())}},{key:"addMany",value:function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];for(var i=0;i<r.length;i++)this.add(e,r[i])}},{key:"createBody_",value:function(e,t){this.body_={},this.body_[e]=t}},{key:"getObject",value:function(){return this.body_}}]),e}(),Geo=function(){function e(){classCallCheck(this,e)}return createClass(e,null,[{key:"boundingBox",value:function(t,r){return new e.BoundingBox(t,r)}},{key:"circle",value:function(t,r){return new e.Circle(t,r)}},{key:"line",value:function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return new(Function.prototype.bind.apply(e.Line,[null].concat(r)))}},{key:"point",value:function(t,r){return new e.Point(t,r)}},{key:"polygon",value:function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return new(Function.prototype.bind.apply(e.Polygon,[null].concat(r)))}}]),e}(),Point=function(e){function t(e,r){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.body_=[e,r],n}return inherits(t,e),t}(Embodied);Geo.Point=Point;var Line=function(e){function t(){classCallCheck(this,t);for(var e=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this)),r=arguments.length,n=Array(r),i=0;i<r;i++)n[i]=arguments[i];return e.body_={type:"linestring",coordinates:n.map(function(e){return Embodied.toBody(e)})},e}return inherits(t,e),t}(Embodied);Geo.Line=Line;var BoundingBox=function(e){function t(e,r){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.body_={type:"envelope",coordinates:[Embodied.toBody(e),Embodied.toBody(r)]},n}return inherits(t,e),createClass(t,[{key:"getPoints",value:function(){return this.body_.coordinates}}]),t}(Embodied);Geo.BoundingBox=BoundingBox;var Circle=function(e){function t(e,r){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.body_={type:"circle",coordinates:Embodied.toBody(e),radius:r},n}return inherits(t,e),createClass(t,[{key:"getCenter",value:function(){return this.body_.coordinates}},{key:"getRadius",value:function(){return this.body_.radius}}]),t}(Embodied);Geo.Circle=Circle;var Polygon=function(e){function t(){classCallCheck(this,t);var e=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.body_={type:"polygon",coordinates:[]},e.addCoordinates_.apply(e,arguments),e}return inherits(t,e),createClass(t,[{key:"addCoordinates_",value:function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.body_.coordinates.push(t.map(function(e){return Embodied.toBody(e)}))}},{key:"hole",value:function(){return this.addCoordinates_.apply(this,arguments),this}}]),t}(Embodied);Geo.Polygon=Polygon;var Range=function(e){function t(e,r){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return metal.core.isDefAndNotNull(e)&&(n.body_.from=e),metal.core.isDefAndNotNull(r)&&(n.body_.to=r),n}return inherits(t,e),createClass(t,null,[{key:"from",value:function(e){return new t(e)}},{key:"range",value:function(e,r){return new t(e,r)}},{key:"to",value:function(e){return new t(null,e)}}]),t}(Embodied),Filter=function(e){function t(e,r,n){classCallCheck(this,t);var i=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.body_=new FilterBody(e,r,n),i}return inherits(t,e),createClass(t,[{key:"add",value:function(e,r,n,i){var o=r?t.toFilter(r,n,i):null;return this.body_.add(e,o),this}},{key:"addMany",value:function(e){for(var t,r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];return(t=this.body_).addMany.apply(t,[e].concat(n)),this}},{key:"and",value:function(e,t,r){return this.add("and",e,t,r)}},{key:"body",value:function(){return this.body_.getObject()}},{key:"or",value:function(e,t,r){return this.add("or",e,t,r)}}],[{key:"any",value:function(e){var r=Array.prototype.slice.call(arguments,1);return 1===r.length&&r[0]instanceof Array&&(r=r[0]),new t(e,"any",r)}},{key:"boundingBox",value:function(e,r,n){return r instanceof Geo.BoundingBox?t.polygon.apply(t,[e].concat(toConsumableArray(r.getPoints()))):t.polygon(e,r,n)}},{key:"distance",value:function(e,r,n){var i=r,o=n;return r instanceof Geo.Circle?(i=r.getCenter(),o=Range.to(r.getRadius())):n instanceof Range||(o=Range.to(n)),t.distanceInternal_(e,i,o)}},{key:"distanceInternal_",value:function(e,r,n){var i={location:Embodied.toBody(r)};return n=n.body(),n.from&&(i.min=n.from),n.to&&(i.max=n.to),t.field(e,"gd",i)}},{key:"equal",value:function(e,r){return new t(e,"=",r)}},{key:"exists",value:function(e){return t.field(e,"exists",null)}},{key:"fuzzy",value:function(e,r,n){return t.fuzzyInternal_("fuzzy",e,r,n)}},{key:"fuzzyInternal_",value:function(e,r,n,i){var o=metal.core.isString(n),a={query:o?n:r},u=o?i:n;u&&(a.fuzziness=u);var s=o?r:t.ALL;return t.field(s,e,a)}},{key:"gt",value:function(e,r){return new t(e,">",r)}},{key:"gte",value:function(e,r){return new t(e,">=",r)}},{key:"match",value:function(e,r){var n=metal.core.isString(r)?e:t.ALL,i=metal.core.isString(r)?r:e;return t.field(n,"match",i)}},{key:"missing",value:function(e){return t.field(e,"missing",null)}},{key:"phrase",value:function(e,r){var n=metal.core.isString(r)?e:t.ALL,i=metal.core.isString(r)?r:e;return t.field(n,"phrase",i)}},{key:"polygon",value:function(e){for(var r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];return n=n.map(function(e){return Embodied.toBody(e)}),t.field(e,"gp",n)}},{key:"prefix",value:function(e,r){var n=r?e:t.ALL,i=r?r:e;return t.field(n,"prefix",i)}},{key:"range",value:function r(e,n,i){var r=n;return r instanceof Range||(r=Range.range(n,i)),t.field(e,"range",r)}},{key:"regex",value:function(e,r){return new t(e,"~",r)}},{key:"shape",value:function(e){for(var r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];n=n.map(function(e){return Embodied.toBody(e)});var o={type:"geometrycollection",geometries:n};return t.field(e,"gs",o)}},{key:"similar",value:function(e,r){var n=metal.core.isString(r)?e:t.ALL,i={query:metal.core.isString(r)?r:e};return t.field(n,"similar",i)}},{key:"lt",value:function(e,r){return new t(e,"<",r)}},{key:"lte",value:function(e,r){return new t(e,"<=",r)}},{key:"none",value:function(e){var r=Array.prototype.slice.call(arguments,1);return 1===r.length&&r[0]instanceof Array&&(r=r[0]),new t(e,"none",r)}},{key:"notEqual",value:function(e,r){return new t(e,"!=",r)}},{key:"not",value:function(e,r,n){return t.toFilter(e,r,n).add("not")}},{key:"field",value:function(e,r,n){return new t(e,r,n)}},{key:"toFilter",value:function(e,r,n){var i=e;return i instanceof t||(i=t.field(e,r,n)),i}}]),t}(Embodied);Filter.ALL="*";var Aggregation=function(){function e(t,r,n){classCallCheck(this,e),this.field_=t,this.operator_=r,this.value_=n}return createClass(e,[{key:"getField",value:function(){return this.field_}},{key:"getOperator",value:function(){return this.operator_}},{key:"getValue",value:function(){return this.value_}}],[{key:"avg",value:function(t){return e.field(t,"avg")}},{key:"count",value:function(t){return e.field(t,"count")}},{key:"distance",value:function(t,r){for(var n=arguments.length,i=Array(n>2?n-2:0),o=2;o<n;o++)i[o-2]=arguments[o];return new(Function.prototype.bind.apply(e.DistanceAggregation,[null].concat([t,r],i)))}},{key:"extendedStats",value:function(t){return e.field(t,"extendedStats")}},{key:"histogram",value:function(t,r){return new e(t,"histogram",r)}},{key:"max",value:function(t){return e.field(t,"max")}},{key:"min",value:function(t){return e.field(t,"min")}},{key:"missing",value:function(t){return e.field(t,"missing")}},{key:"field",value:function(t,r){return new e(t,r)}},{key:"range",value:function(t){for(var r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];return new(Function.prototype.bind.apply(e.RangeAggregation,[null].concat([t],n)))}},{key:"stats",value:function(t){return e.field(t,"stats")}},{key:"sum",value:function(t){return e.field(t,"sum")}},{key:"terms",value:function(t){return e.field(t,"terms")}}]),e}(),DistanceAggregation=function(e){function t(e,r){classCallCheck(this,t);var n=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,"geoDistance",{}));n.value_.location=Embodied.toBody(r);for(var i=arguments.length,o=Array(i>2?i-2:0),a=2;a<i;a++)o[a-2]=arguments[a];return n.value_.ranges=o.map(function(e){return e.body()}),n}return inherits(t,e),createClass(t,[{key:"range",value:function r(e,t){var r=e;return r instanceof Range||(r=Range.range(e,t)),this.value_.ranges.push(r.body()),this}},{key:"unit",value:function(e){return this.value_.unit=e,this}}]),t}(Aggregation);Aggregation.DistanceAggregation=DistanceAggregation;var RangeAggregation=function(e){function t(e){classCallCheck(this,t);for(var r=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,"range")),n=arguments.length,i=Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];return r.value_=i.map(function(e){return e.body()}),r}return inherits(t,e),createClass(t,[{key:"range",value:function r(e,t){var r=e;return r instanceof Range||(r=Range.range(e,t)),this.value_.push(r.body()),this}}]),t}(Aggregation);Aggregation.RangeAggregation=RangeAggregation;var Query=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"aggregate",value:function(e,t,r){var n=t;n instanceof Aggregation||(n=Aggregation.field(t,r));var i=n.getField(),o={};return o[i]={name:e,operator:n.getOperator()},metal.core.isDefAndNotNull(n.getValue())&&(o[i].value=n.getValue()),this.body_.aggregation||(this.body_.aggregation=[]),this.body_.aggregation.push(o),this}},{key:"count",value:function(){return this.type("count")}},{key:"fetch",value:function(){return this.type("fetch")}},{key:"filter",value:function r(e,t,n){var r=Filter.toFilter(e,t,n);return this.body_.filter||(this.body_.filter=[]),this.body_.filter.push(r.body()),this}},{key:"offset",value:function(e){return this.body_.offset=e,this}},{key:"highlight",value:function(e){return this.body_.highlight||(this.body_.highlight=[]),this.body_.highlight.push(e),this}},{key:"limit",value:function(e){return this.body_.limit=e,this}},{key:"search",value:function(e,t,r){var n=e;return r?n=Filter.field(e,t,r):t?n=Filter.match(e,t):n instanceof Filter||(n=Filter.match(e)),this.body_.search||(this.body_.search=[]),metal.core.isDefAndNotNull(e)?this.body_.search.push(n.body()):this.body_.search.push({}),this}},{key:"sort",value:function(e,t){this.body_.sort||(this.body_.sort=[]);var r={};return r[e]=t||"asc",this.body_.sort.push(r),this}},{key:"type",value:function(e){return this.body_.type=e,this}}],[{key:"aggregate",value:function(e,r,n){return(new t).aggregate(e,r,n)}},{key:"count",value:function(){return(new t).type("count")}},{key:"fetch",value:function(){return(new t).type("fetch")}},{key:"filter",value:function(e,r,n){return(new t).filter(e,r,n)}},{key:"offset",value:function(e){return(new t).offset(e)}},{key:"highlight",value:function(e){return(new t).highlight(e)}},{key:"limit",value:function(e){return(new t).limit(e)}},{key:"search",value:function(e,r,n){return(new t).search(e,r,n)}},{key:"sort",value:function(e,r){return(new t).sort(e,r)}},{key:"type",value:function(e){return(new t).type(e)}}]),t}(Embodied),globals={};"undefined"!=typeof window&&(globals.window=window),"undefined"!=typeof document&&(globals.document=document);var Auth=function(){function e(t){var r=arguments.length<=1||void 0===arguments[1]?null:arguments[1];classCallCheck(this,e),this.token=metal.core.isString(r)?null:t,this.email=metal.core.isString(r)?t:null,this.password=r,this.createdAt=null,this.id=null,this.name=null,this.photoUrl=null,this.wedeployClient=null}return createClass(e,[{key:"getCreatedAt",value:function(){return this.createdAt}},{key:"getEmail",value:function(){return this.email}},{key:"getId",value:function(){return this.id}},{key:"getName",value:function(){return this.name}},{key:"getPassword",value:function(){return this.password}},{key:"getPhotoUrl",value:function(){return this.photoUrl}},{key:"getToken",value:function(){return this.token}},{key:"hasCreatedAt",value:function(){return metal.core.isDefAndNotNull(this.createdAt)}},{key:"hasEmail",value:function(){return metal.core.isDefAndNotNull(this.email)}},{key:"hasId",value:function(){return metal.core.isDefAndNotNull(this.id)}},{key:"hasName",value:function(){return metal.core.isDefAndNotNull(this.name)}},{key:"hasPassword",value:function(){return metal.core.isDefAndNotNull(this.password)}},{key:"hasPhotoUrl",value:function(){return metal.core.isDefAndNotNull(this.photoUrl)}},{key:"hasToken",value:function(){return metal.core.isDefAndNotNull(this.token)}},{key:"setCreatedAt",value:function(e){this.createdAt=e}},{key:"setEmail",value:function(e){this.email=e}},{key:"setId",value:function(e){this.id=e}},{key:"setName",value:function(e){this.name=e}},{key:"setPassword",value:function(e){this.password=e}},{key:"setPhotoUrl",value:function(e){this.photoUrl=e}},{key:"setToken",value:function(e){this.token=e}},{key:"setWedeployClient",value:function(e){this.wedeployClient=e}},{key:"updateUser",value:function(e){return assertObject(e,"User data must be specified as object"),this.wedeployClient.url(this.wedeployClient.authUrl_).path("/users").auth(this).patch(e).then(function(e){return assertResponseSucceeded(e)})}},{key:"deleteUser",value:function(){return assertDefAndNotNull(this.id,"Cannot delete user without id"),this.wedeployClient.url(this.wedeployClient.authUrl_).path("/users",this.id).auth(this)["delete"]().then(function(e){return assertResponseSucceeded(e)})}}],[{key:"create",value:function(t,r){return new e(t,r)}}]),e}(),ApiHelper=function(){function e(t){classCallCheck(this,e),assertDefAndNotNull(t,"WeDeploy client reference must be specified"),this.wedeployClient=t}return createClass(e,[{key:"auth",value:function(e,t){return this.helperAuthScope=e,this.helperAuthScope instanceof Auth||(this.helperAuthScope=Auth.create(e,t)),this}}]),e}(),AuthProvider=function(){function e(){classCallCheck(this,e),this.provider=null,this.providerScope=null,this.redirectUri=null,this.scope=null}return createClass(e,[{key:"hasProvider",value:function(){return metal.core.isDefAndNotNull(this.provider)}},{key:"hasProviderScope",value:function(){return metal.core.isDefAndNotNull(this.providerScope)}},{key:"hasRedirectUri",value:function(){return metal.core.isDefAndNotNull(this.redirectUri)}},{key:"hasScope",value:function(){return metal.core.isDefAndNotNull(this.scope)}},{key:"makeAuthorizationUrl",value:function(e){var t=new Uri(e);return t.setPathname("/oauth/authorize"),this.hasProvider()&&t.setParameterValue("provider",this.getProvider()),this.hasProviderScope()&&t.setParameterValue("provider_scope",this.getProviderScope()),this.hasRedirectUri()&&t.setParameterValue("redirect_uri",this.getRedirectUri()),this.hasScope()&&t.setParameterValue("scope",this.getScope()),t.toString()}},{key:"getProvider",value:function(){return this.provider}},{key:"getProviderScope",value:function(){return this.providerScope}},{key:"getRedirectUri",value:function(){return this.redirectUri}},{key:"getScope",value:function(){return this.scope}},{key:"setProviderScope",value:function(e){assertStringIfDefAndNotNull(e,"Provider scope must be a string"),this.providerScope=e}},{key:"setRedirectUri",value:function(e){assertStringIfDefAndNotNull(e,"Redirect uri must be a string"),this.redirectUri=e}},{key:"setScope",value:function(e){assertStringIfDefAndNotNull(e,"Scope must be a string"),this.scope=e}}]),e}(),FacebookAuthProvider=function(e){function t(){classCallCheck(this,t);var e=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.provider=t.PROVIDER,e}return inherits(t,e),t}(AuthProvider);FacebookAuthProvider.PROVIDER="facebook";var GithubAuthProvider=function(e){function t(){classCallCheck(this,t);var e=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.provider=t.PROVIDER,e}return inherits(t,e),t}(AuthProvider);GithubAuthProvider.PROVIDER="github";var GoogleAuthProvider=function(e){function t(){classCallCheck(this,t);var e=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.provider=t.PROVIDER,e}return inherits(t,e),t}(AuthProvider);GoogleAuthProvider.PROVIDER="google";var AuthApiHelper=function(e){function t(e){classCallCheck(this,t);var r=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.currentUser=null,r.onSignInCallback=null,r.onSignOutCallback=null,metalStorage.LocalStorageMechanism.isSupported()&&(r.storage=new metalStorage.Storage(new metalStorage.LocalStorageMechanism)),r.processSignIn_(),r.provider={Facebook:FacebookAuthProvider,Google:GoogleAuthProvider,Github:GithubAuthProvider},r}return inherits(t,e),createClass(t,[{key:"createUser",value:function(e){var t=this;return assertObject(e,"User data must be specified as object"),this.wedeployClient.url(this.wedeployClient.authUrl_).path("/users").post(e).then(function(e){return assertResponseSucceeded(e)}).then(function(e){return t.makeUserAuthFromData(e.body())})}},{key:"getHrefWithoutFragment_",value:function(){var e=globals.window.location;return e.protocol+"//"+e.host+e.pathname+(e.search?e.search:"")}},{key:"getRedirectAccessToken_",value:function(){if(globals.window){var e=globals.window.location.hash;if(0===e.indexOf("#access_token="))return e.substring(14)}return null}},{key:"getUser",value:function(e){var t=this;return assertDefAndNotNull(e,"User userId must be specified"),assertUserSignedIn(this.currentUser),this.wedeployClient.url(this.wedeployClient.authUrl_).path("/users",e).auth(this.resolveAuthScope().token).get().then(function(e){return assertResponseSucceeded(e)}).then(function(e){return t.makeUserAuthFromData(e.body())})}},{key:"loadCurrentUser",value:function(e){var t=this;return assertDefAndNotNull(e,"User token must be specified"),this.wedeployClient.url(this.wedeployClient.authUrl_).path("/user").auth(e).get().then(function(r){var n=r.body();return n.token=e,t.currentUser=t.makeUserAuthFromData(n),t.storage&&t.storage.set("currentUser",n),t.currentUser})}},{key:"makeUserAuthFromData",value:function(e){var t=new Auth;return t.setWedeployClient(this.wedeployClient),t.setCreatedAt(e.createdAt),t.setEmail(e.email),t.setId(e.id),t.setName(e.name),t.setPhotoUrl(e.photoUrl),t.setToken(e.token),t}},{key:"maybeCallOnSignInCallback_",value:function(){this.onSignInCallback&&this.onSignInCallback.call(this,this.currentUser)}},{key:"maybeCallOnSignOutCallback_",value:function(){this.onSignOutCallback&&this.onSignOutCallback.call(this,this.currentUser)}},{key:"onSignIn",value:function(e){assertFunction(e,"Sign-in callback must be a function"),this.onSignInCallback=e}},{key:"onSignOut",value:function(e){assertFunction(e,"Sign-out callback must be a function"),this.onSignOutCallback=e}},{key:"processSignIn_",value:function(){var e=this,t=this.getRedirectAccessToken_();if(t)return this.removeUrlFragmentCompletely_(),void this.loadCurrentUser(t).then(function(){return e.maybeCallOnSignInCallback_()});var r=this.storage&&this.storage.get("currentUser");r&&(this.currentUser=this.makeUserAuthFromData(r))}},{key:"removeUrlFragmentCompletely_",value:function(){globals.window.history.pushState({},document.title,window.location.pathname+window.location.search)}},{key:"resolveAuthScope",value:function(){return this.helperAuthScope?this.helperAuthScope:this.currentUser}},{key:"sendPasswordResetEmail",value:function(e){return assertDefAndNotNull(e,"Send password reset email must be specified"),this.wedeployClient.url(this.wedeployClient.authUrl_).path("/user/recover").param("email",e).post().then(function(e){return assertResponseSucceeded(e)})}},{key:"signInWithEmailAndPassword",value:function(e,t){var r=this;return assertDefAndNotNull(e,"Sign-in email must be specified"),assertDefAndNotNull(t,"Sign-in password must be specified"),this.wedeployClient.url(this.wedeployClient.authUrl_).path("/oauth/token").param("grant_type","password").param("username",e).param("password",t).get().then(function(e){return assertResponseSucceeded(e)}).then(function(e){return r.loadCurrentUser(e.body().access_token)}).then(function(e){return r.maybeCallOnSignInCallback_(),e})}},{key:"signInWithRedirect",value:function(e){assertBrowserEnvironment(),assertDefAndNotNull(e,"Sign-in provider must be defined"),assertSupportedProvider(e),e.hasRedirectUri()||e.setRedirectUri(this.getHrefWithoutFragment_()),globals.window.location.href=e.makeAuthorizationUrl(this.wedeployClient.authUrl_)}},{key:"signOut",value:function(){var e=this;return assertUserSignedIn(this.currentUser),this.wedeployClient.url(this.wedeployClient.authUrl_).path("/oauth/revoke").param("token",this.currentUser.token).get().then(function(e){return assertResponseSucceeded(e)}).then(function(t){return e.maybeCallOnSignOutCallback_(),e.unloadCurrentUser_(),t})}},{key:"unloadCurrentUser_",value:function(){this.currentUser=null,this.storage&&this.storage.remove("currentUser")}}]),t}(ApiHelper),DataApiHelper=function(e){function t(e){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return inherits(t,e),createClass(t,[{key:"where",value:function(e,t,r){return this.getOrCreateFilter_().and(e,t,r),this}},{key:"or",value:function(e,t,r){if(0===this.getOrCreateFilter_().body().and.length)throw Error("It's required to have a condition before using an 'or()' for the first time.");return this.getOrCreateFilter_().or(e,t,r),this}},{key:"none",value:function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return this.where(Filter.none(e,r))}},{key:"match",value:function(e,t){return this.where(Filter.match(e,t))}},{key:"similar",value:function(e,t){return this.where(Filter.similar(e,t))}},{key:"lt",value:function(e,t){return this.where(Filter.lt(e,t))}},{key:"lte",value:function(e,t){return this.where(Filter.lte(e,t))}},{key:"any",value:function(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return this.where(Filter.any(e,r))}},{key:"boundingBox",value:function(e,t,r){return this.where(Filter.boundingBox(e,t,r))}},{key:"distance",value:function(e,t,r){return this.where(Filter.distance(e,t,r))}},{key:"range",value:function(e,t,r){return this.where(Filter.range(e,t,r))}},{key:"limit",value:function(e){return this.getOrCreateQuery_().limit(e),this}},{key:"offset",value:function(e){return this.getOrCreateQuery_().offset(e),this}},{key:"highlight",value:function(e){return this.getOrCreateQuery_().highlight(e),this}},{key:"aggregate",value:function(e,t,r){return this.getOrCreateQuery_().aggregate(e,t,r),this}},{key:"count",value:function(){return this.getOrCreateQuery_().type("count"),this}},{key:"orderBy",value:function(e,t){return this.getOrCreateQuery_().sort(e,t),this}},{key:"create",value:function(e,t){return assertDefAndNotNull(e,"Collection key must be specified."),assertObject(t,"Data can't be empty."),this.wedeployClient.url(this.wedeployClient.dataUrl_).auth(this.helperAuthScope).path(e).post(t).then(function(e){return assertResponseSucceeded(e)}).then(function(e){return e.body()})}},{key:"update",value:function(e,t){return assertDefAndNotNull(e,"Document key must be specified."),assertObject(t,"Data must be specified."),this.wedeployClient.url(this.wedeployClient.dataUrl_).auth(this.helperAuthScope).path(e).put(t).then(function(e){return assertResponseSucceeded(e)}).then(function(e){return e.body()})}},{key:"delete",value:function(e){return assertDefAndNotNull(e,"Document/Field/Collection key must be specified"),this.wedeployClient.url(this.wedeployClient.dataUrl_).auth(this.helperAuthScope).path(e)["delete"]().then(function(e){return assertResponseSucceeded(e)}).then(function(){})}},{key:"get",value:function(e){return assertDefAndNotNull(e,"Document/Field/Collection key must be specified"),this.addFiltersToQuery_(),this.wedeployClient.url(this.wedeployClient.dataUrl_).auth(this.helperAuthScope).path(e).get(this.query_).then(function(e){return assertResponseSucceeded(e)}).then(function(e){return e.body()})}},{key:"search",value:function(e){return assertDefAndNotNull(e,"Document/Field/Collection key must be specified"),this.onSearch_(),this.addFiltersToQuery_(),this.wedeployClient.url(this.wedeployClient.dataUrl_).auth(this.helperAuthScope).path(e).get(this.query_).then(function(e){return assertResponseSucceeded(e)}).then(function(e){return e.body()})}},{key:"watch",value:function(e,t){return assertDefAndNotNull(e,"Collection key must be specified"),this.addFiltersToQuery_(),this.wedeployClient.url(this.wedeployClient.dataUrl_).auth(this.helperAuthScope).path(e).watch(this.query_,t)}},{key:"getOrCreateFilter_",value:function(){return this.filter_||(this.filter_=new Filter),this.filter_}},{key:"getOrCreateQuery_",value:function(){return this.query_||(this.query_=new Query),this.query_}},{key:"addFiltersToQuery_",value:function(){return metal.core.isDef(this.filter_)&&this.toSearch_!==!0&&this.getOrCreateQuery_().filter(this.filter_),this}},{key:"onSearch_",value:function(){if(!metal.core.isDef(this.filter_))throw Error("It's required to have a condition before using an 'search()' for the first time.");return this.getOrCreateQuery_().search(this.getOrCreateFilter_()),this.toSearch_=!0,this}}]),t}(ApiHelper),Base64=function(){function e(){classCallCheck(this,e)}return createClass(e,null,[{key:"encodeString",value:function(e){return"function"==typeof btoa?btoa(e):new Buffer(e.toString(),"binary")}}]),e}(),Transport=function(){function e(){classCallCheck(this,e)}return createClass(e,[{key:"send",value:function(){}}]),e}(),ClientMessage=function(){function e(){classCallCheck(this,e),this.headers_=new metalStructs.MultiMap}return createClass(e,[{key:"body",value:function(e){return metal.core.isDef(e)?(this.body_=e,this):this.body_}},{key:"header",value:function(e,t){if(2!==arguments.length)throw new Error("Invalid arguments");return this.headers_.set(e,t),this}},{key:"headers",value:function(e){return metal.core.isDef(e)?(e instanceof metalStructs.MultiMap?this.headers_=e:this.headers_.values=e,e):this.headers_}},{key:"removeBody",value:function(){this.body_=void 0}}]),e}(),ClientResponse=function(e){function t(e){classCallCheck(this,t);var r=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));if(!e)throw new Error("Can't create response without request");return r.clientRequest_=e,r}return inherits(t,e),createClass(t,[{key:"request",value:function(){return this.clientRequest_}},{key:"statusCode",value:function(e){return metal.core.isDef(e)?(this.statusCode_=e,this):this.statusCode_}},{key:"statusText",value:function(e){return metal.core.isDef(e)?(this.statusText_=e,this):this.statusText_}},{key:"succeeded",value:function(){return this.statusCode()>=200&&this.statusCode()<=399}}]),t}(ClientMessage),AjaxTransport=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"send",value:function(e){var t=Ajax.request(e.url(),e.method(),e.body(),e.headers(),e.params(),null,!1,e.withCredentials());return t.then(function(t){var r=new ClientResponse(e);return r.body(t.responseText),r.statusCode(t.status),r.statusText(t.statusText),Ajax.parseResponseHeaders(t.getAllResponseHeaders()).forEach(function(e){r.header(e.name,e.value)}),r})}}]),t}(Transport),TransportFactory=function(){function e(){classCallCheck(this,e),this.transports={},this.transports[e.DEFAULT_TRANSPORT_NAME]=e[e.DEFAULT_TRANSPORT_NAME]}return createClass(e,[{key:"get",value:function(e){var t=this.transports[e];if(!t)throw new Error("Invalid transport name: "+e);try{return new t}catch(r){throw new Error("Can't create transport",r)}}},{
key:"getDefault",value:function(){return this.get(e.DEFAULT_TRANSPORT_NAME)}}],[{key:"instance",value:function(){return e.instance_||(e.instance_=new e),e.instance_}}]),e}();TransportFactory.DEFAULT_TRANSPORT_NAME="default",TransportFactory[TransportFactory.DEFAULT_TRANSPORT_NAME]=AjaxTransport;var ClientRequest=function(e){function t(){classCallCheck(this,t);var e=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.params_=new metalStructs.MultiMap,e.withCredentials_=!0,e}return inherits(t,e),createClass(t,[{key:"withCredentials",value:function(e){return metal.core.isDef(e)?(this.withCredentials_=!!e,this):this.withCredentials_}},{key:"method",value:function(e){return metal.core.isDef(e)?(this.method_=e,this):this.method_||t.DEFAULT_METHOD}},{key:"param",value:function(e,t){if(2!==arguments.length)throw new Error("Invalid arguments");return this.params_.set(e,t),this}},{key:"params",value:function(e){return metal.core.isDef(e)?(e instanceof metalStructs.MultiMap?this.params_=e:this.params_.values=e,e):this.params_}},{key:"url",value:function(e){return metal.core.isDef(e)?(this.url_=e,this):this.url_}}]),t}(ClientMessage);ClientRequest.DEFAULT_METHOD="GET";var io$1;"undefined"!=typeof globals.window&&(io$1=globals.window.io);var WeDeploy$1=function(){function e(t){for(var r=arguments.length,n=Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];if(classCallCheck(this,e),0===arguments.length)throw new Error("Invalid arguments, try `new WeDeploy(baseUrl, url)`");this.auth_=null,this.body_=null,this.url_=Uri.joinPaths.apply(Uri,[t||""].concat(n)),this.headers_=new metalStructs.MultiMap,this.params_=new metalStructs.MultiMap,this.withCredentials_=!0,this.header("Content-Type","application/json"),this.header("X-Requested-With","XMLHttpRequest")}return createClass(e,[{key:"auth",value:function(e,t){return this.auth_=e,this.auth_ instanceof Auth||(this.auth_=Auth.create(e,t)),this}},{key:"body",value:function(e){return this.body_=e,this}},{key:"convertBodyToParams_",value:function(e,t){metal.core.isString(t)?t={body:t}:t instanceof Embodied&&(t=t.body()),Object.keys(t||{}).forEach(function(r){return e.param(r,t[r])})}},{key:"createClientRequest_",value:function(e,t){var r=new ClientRequest;return r.body(t||this.body_),metal.core.isDefAndNotNull(r.body())||this.formData_&&r.body(this.formData_),r.method(e),r.headers(this.headers()),r.params(this.params()),r.url(this.url()),r.withCredentials(this.withCredentials_),this.encode(r),r}},{key:"decode",value:function(t){if(e.isContentTypeJson(t))try{t.body(JSON.parse(t.body()))}catch(r){}return t}},{key:"delete",value:function(e){return this.sendAsync("DELETE",e)}},{key:"encode",value:function(t){var r=t.body();return metal.core.isElement(r)&&(r=new FormData(r),t.body(r)),r=this.maybeWrapWithQuery_(r),"GET"===t.method()&&(this.convertBodyToParams_(t,r),t.removeBody(),r=null),"undefined"!=typeof FormData&&r instanceof FormData?t.headers().remove("content-type"):r instanceof Embodied?t.body(r.toString()):e.isContentTypeJson(t)&&t.body(JSON.stringify(t.body())),this.encodeParams_(t),this.resolveAuthentication_(t),t}},{key:"encodeParams_",value:function(e){var t=e.params();t.names().forEach(function(e){var r=t.getAll(e);r.forEach(function(e,t){e instanceof Embodied?e=e.toString():(metal.core.isObject(e)||e instanceof Array)&&(e=JSON.stringify(e)),r[t]=e})})}},{key:"form",value:function(e,t){if("undefined"==typeof FormData)throw new Error("form() is only available when FormData API is available.");return this.formData_||(this.formData_=new FormData),this.formData_.append(e,t),this}},{key:"get",value:function(e){return this.sendAsync("GET",e)}},{key:"header",value:function(e,t){if(2!==arguments.length)throw new Error("Invalid arguments");return this.headers_.set(e,t),this}},{key:"headers",value:function(){return this.headers_}},{key:"maybeWrapWithQuery_",value:function(e){return e instanceof Filter&&(e=Query.filter(e)),e}},{key:"param",value:function(e,t){if(2!==arguments.length)throw new Error("Invalid arguments");return this.params_.set(e,t),this}},{key:"params",value:function(){return this.params_}},{key:"patch",value:function(e){return this.sendAsync("PATCH",e)}},{key:"path",value:function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];var i=new(Function.prototype.bind.apply(e,[null].concat([this.url()],r)));return metal.core.isDefAndNotNull(this.auth_)&&i.auth(this.auth_),i.use(this.customTransport_)}},{key:"post",value:function(e){return this.sendAsync("POST",e)}},{key:"put",value:function(e){return this.sendAsync("PUT",e)}},{key:"resolveAuthentication_",value:function(e){if(this.auth_)if(this.auth_.hasToken())e.header("Authorization","Bearer "+this.auth_.token);else{var t=this.auth_.email+":"+this.auth_.password;e.header("Authorization","Basic "+Base64.encodeString(t))}}},{key:"sendAsync",value:function(e,t){var r=this.customTransport_||TransportFactory.instance().getDefault(),n=this.createClientRequest_(e,t);return r.send(n).then(this.decode)}},{key:"url",value:function(){return this.url_}},{key:"use",value:function(e){return this.customTransport_=e,this}},{key:"watch",value:function(e,t){if("undefined"==typeof io$1)throw new Error("Socket.io client not loaded");var r=this.createClientRequest_("GET",e),n=new Uri(r.url());return n.addParametersFromMultiMap(r.params()),t=t||{forceNew:!0},t.query="url="+encodeURIComponent(n.getPathname()+n.getSearch()),t.path=t.path||n.getPathname(),io$1(n.getHost(),t)}},{key:"withCredentials",value:function(e){return this.withCredentials_=!!e,this}}],[{key:"data",value:function t(r){assertUriWithNoPath(r,"The data url should not have a path"),metal.core.isString(r)&&(e.dataUrl_=r);var t=new DataApiHelper(e);return t.auth(e.auth().currentUser),t}},{key:"auth",value:function(t){return metal.core.isString(t)&&(e.authUrl_=t),e.auth_||(e.auth_=new AuthApiHelper(e)),e.auth_}},{key:"socket",value:function(e){io$1=e}},{key:"url",value:function(t){return new e(t).use(this.customTransport_)}}]),e}();WeDeploy$1.isContentTypeJson=function(e){var t=e.headers().get("content-type")||"";return 0===t.indexOf("application/json")},WeDeploy$1.auth_=null,WeDeploy$1.authUrl_="",WeDeploy$1.data_=null,WeDeploy$1.dataUrl_="";var NodeTransport=function(e){function t(){return classCallCheck(this,t),possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return inherits(t,e),createClass(t,[{key:"send",value:function(e){var t=this.request(e.url(),e.method(),e.body(),e.headers(),e.params(),null,!1);return t.then(function(t){var r=new ClientResponse(e);return r.body(t.body),r.statusCode(t.statusCode),r.statusText(http.STATUS_CODES[t.statusCode]),Object.keys(t.headers).forEach(function(e){r.header(e,t.headers[e])}),r})}},{key:"request",value:function(e,t,r,n,i,o){i&&(e=new Uri(e).addParametersFromMultiMap(i).toString());var a={method:t,uri:e};n&&!function(){var e={};n.names().forEach(function(t){e[t]=n.getAll(t).join(", ")}),a.headers=e}(),r&&(a.body=r),o&&(a.timeout=o);var u;return new CancellablePromise(function(e,t){u=_request(a,function(r,n){return r?void t(r):void e(n)})}).thenCatch(function(e){throw u.abort(),e})}}]),t}(Transport);TransportFactory[TransportFactory.DEFAULT_TRANSPORT_NAME]=NodeTransport,WeDeploy$1.socket(io),WeDeploy$1.Filter=Filter,WeDeploy$1.Geo=Geo,WeDeploy$1.Query=Query,WeDeploy$1.Range=Range,WeDeploy$1.WeDeploy=WeDeploy$1,module.exports=WeDeploy$1;